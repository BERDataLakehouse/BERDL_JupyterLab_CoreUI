name: PR Prerelease

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

concurrency:
  group: pr-prerelease-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # Call the reusable build workflow
  build:
    if: github.event.action != 'closed'
    uses: ./.github/workflows/build.yml

  # Create prerelease after build succeeds
  create-prerelease:
    if: github.event.action != 'closed'
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: extension-artifacts
          path: dist

      - name: Get version and set tag
        id: version
        run: |
          VERSION=$(jq -r '.version' package.json)
          TAG="v${VERSION}-pr${{ github.event.pull_request.number }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Building prerelease: $TAG"

      - name: Delete existing prerelease (if any)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release delete "${{ steps.version.outputs.tag }}" --yes 2>/dev/null || true
          git push origin --delete "${{ steps.version.outputs.tag }}" 2>/dev/null || true

      - name: Create prerelease
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ steps.version.outputs.tag }}" \
            --title "PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}" \
            --notes "Prerelease build for PR #${{ github.event.pull_request.number }}

          **Install with:**
          \`\`\`bash
          pip install https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/berdl_jupyterlab_coreui-${{ steps.version.outputs.version }}-py3-none-any.whl
          \`\`\`

          ---
          Commit: ${{ github.event.pull_request.head.sha }}" \
            --prerelease \
            dist/*

      - name: Comment on PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMENT_BODY="## ðŸ“¦ Prerelease Build Available

          Install this PR's build:
          \`\`\`bash
          pip install https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/berdl_jupyterlab_coreui-${{ steps.version.outputs.version }}-py3-none-any.whl
          \`\`\`

          [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }})"

          # Delete previous bot comments about prereleases
          gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
            --jq '.[] | select(.user.login == "github-actions[bot]" and (.body | contains("Prerelease Build"))) | .id' \
            | xargs -I {} gh api repos/${{ github.repository }}/issues/comments/{} -X DELETE 2>/dev/null || true

          # Add new comment
          gh pr comment ${{ github.event.pull_request.number }} --body "$COMMENT_BODY"

  # Clean up prerelease when PR is closed
  cleanup-prerelease:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version and tag
        id: version
        run: |
          VERSION=$(jq -r '.version' package.json)
          TAG="v${VERSION}-pr${{ github.event.pull_request.number }}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Delete prerelease
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Cleaning up prerelease: ${{ steps.version.outputs.tag }}"
          gh release delete "${{ steps.version.outputs.tag }}" --yes 2>/dev/null || true
          git push origin --delete "${{ steps.version.outputs.tag }}" 2>/dev/null || true
